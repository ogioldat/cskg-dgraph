version: '3.8'

services:
  dgraph-restore:
    image: dgraph/standalone:latest
    container_name: dgraph-restore
    volumes:
      - dgraph_data:/dgraph
      - ./data/backup:/backup
    restart: "no"
    command: >
      dgraph restore --location /backup --force_zero=false --postings /dgraph

  dgraph:
    image: dgraph/standalone:latest
    container_name: dgraph
    depends_on: 
      - dgraph-restore
    ports:
      - "8080:8080"
      - "9080:9080"
    volumes:
      - dgraph_data:/dgraph
      - ../schema/schema.dql:/schema.dql:ro
    command: >-
      bash -lc 'rm -rf p >/dev/null 2>&1 || true; mv p1 p >/dev/null 2>&1 || true; exec /run.sh'
  
  app:
    build:
      context: ..
      dockerfile: ./ci/app.Dockerfile
    working_dir: /app
    entrypoint: ["/usr/local/bin/client"]
    network_mode: host

volumes:
  dgraph_data:

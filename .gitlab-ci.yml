

stages:
  - setup
  - test

variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  DOCKER_DRIVER: overlay2
  COMPOSE_PROJECT_NAME: dgraph-ci

default:
  image: docker:24.0.6
  services:
    - name: docker:24.0.6-dind
      alias: docker

download-backup:
  stage: setup
  before_script:
    - |
      apt-get update
      DEBIAN_FRONTEND=noninteractive apt-get install -y bash python3 python3-pip coreutils
    - pip3 install --no-cache-dir gdown
  script:
    - cd ci
    - echo "Downloading backup"
    - ./scripts/download-backup.sh
  artifacts:
    paths:
      - ci/data/backup
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG =~ /^test.*/

test-job:
  stage: test
  needs:
    - job: download-backup
      artifacts: true
  before_script:
    - |
      if command -v apk >/dev/null 2>&1; then
        apk add --no-cache bash coreutils
      elif command -v apt-get >/dev/null 2>&1; then
        apt-get update
        DEBIAN_FRONTEND=noninteractive apt-get install -y bash coreutils
      else
        echo "Supported package manager not found (apk or apt-get required)." >&2
        exit 1
      fi
  script:
    - cd ci
    - |
      cat <<'RUN_TEST' > run-tests.sh
      #!/usr/bin/env bash
      set -euo pipefail

      cleanup() {
        docker compose down -v || true
      }
      trap cleanup EXIT

      docker compose version
      docker compose build dgraph-client
      docker compose up dgraph-restore
      docker compose up -d dgraph dgraph-client

      set +e
      ./scripts/test.sh > "output_${CI_PROJECT_NAME}.txt"
      test_status=$?
      set -e

      cp "output_${CI_PROJECT_NAME}.txt" ..
      exit "$test_status"
      RUN_TEST
    - bash run-tests.sh
  artifacts:
    paths:
      - output_${CI_PROJECT_NAME}.txt
  rules:
    - if: $CI_COMMIT_TAG =~ /^test.*/

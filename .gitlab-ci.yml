test-job:
  stage: test
  script:
    - cd ci
    - |
      podman info

      if [ -z "${DOCKER_HUB_NAMESPACE:-}" ]; then
        echo "DOCKER_HUB_NAMESPACE env variable must be set to point to your Docker Hub namespace." >&2
        exit 1
      fi

      DOCKER_IMAGE_TAG="${DOCKER_IMAGE_TAG:-latest}"
      DGRAPH_RESTORE_IMAGE="docker.io/${DOCKER_HUB_NAMESPACE}/dgraph-restore:${DOCKER_IMAGE_TAG}"
      DGRAPH_IMAGE="docker.io/${DOCKER_HUB_NAMESPACE}/dgraph:${DOCKER_IMAGE_TAG}"
      DGRAPH_CLIENT_IMAGE="docker.io/${DOCKER_HUB_NAMESPACE}/dgraph-client:${DOCKER_IMAGE_TAG}"

      ./scripts/download-backup.sh

      podman pull "$DGRAPH_RESTORE_IMAGE"
      podman pull "$DGRAPH_IMAGE"
      podman pull "$DGRAPH_CLIENT_IMAGE"

      podman run --rm \
        --name dgraph-restore \
        -v dgraph_data:/dgraph \
        -v $(pwd)/data/backup:/backup:Z \
        "$DGRAPH_RESTORE_IMAGE" \
        dgraph restore \
          --location /backup \
          --force_zero=false \
          --postings /dgraph

      podman run -d \
        --name dgraph \
        -p 8080:8080 \
        -p 9080:9080 \
        -v dgraph_data:/dgraph \
        -v $(pwd)/../schema/schema.dql:/schema.dql:ro,Z \
        "$DGRAPH_IMAGE" \
        bash -lc 'rm -rf p >/dev/null 2>&1 || true; mv p1 p >/dev/null 2>&1 || true; exec /run.sh'

      podman run -d \
        --name dgraph-client \
        --network host \
        -w /app \
        "$DGRAPH_CLIENT_IMAGE" \
        sleep 666h

      set +e
      ./scripts/test.sh > "output_${CI_PROJECT_NAME}.txt"
      test_status=$?
      set -e

      cp "output_${CI_PROJECT_NAME}.txt" ..
      exit "$test_status"
      RUN_TEST
    - bash run-tests.sh
  artifacts:
    paths:
      - output_${CI_PROJECT_NAME}.txt
  rules:
    - if: $CI_COMMIT_TAG =~ /^test.*/

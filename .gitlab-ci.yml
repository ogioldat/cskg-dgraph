

stages:
  - setup
  - test

download-backup:
  stage: setup
  before_script:
    - cat /etc/os-release || uname -a
    - |
      if command -v apk >/dev/null 2>&1; then
        apk add --no-cache bash python3 py3-pip coreutils
      elif command -v apt-get >/dev/null 2>&1; then
        apt-get update
        DEBIAN_FRONTEND=noninteractive apt-get install -y bash python3 python3-pip coreutils
      else
        echo "Supported package manager not found (apk or apt-get required)." >&2
        exit 1
      fi
    - pip3 install --no-cache-dir gdown
  script:
    - cd ci
    - echo "Downloading backup"
    - ./scripts/download-backup.sh
  artifacts:
    paths:
      - ci/data/backup
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG =~ /^test.*/

test-job:
  stage: test
  needs:
    - job: download-backup
      artifacts: true
  before_script:
    - cat /etc/os-release || uname -a
    - |
      if command -v apk >/dev/null 2>&1; then
        apk add --no-cache bash coreutils
      elif command -v apt-get >/dev/null 2>&1; then
        apt-get update
        DEBIAN_FRONTEND=noninteractive apt-get install -y bash coreutils
      else
        echo "Supported package manager not found (apk or apt-get required)." >&2
        exit 1
      fi
  script:
    - cd ci
    - |
      cat <<'RUN_TEST' > run-tests.sh
      #!/usr/bin/env bash
      set -euo pipefail

      cleanup() {
        podman compose down -v || true
      }
      trap cleanup EXIT

      podman compose version
      podman compose build dgraph-client
      podman compose up dgraph-restore
      podman compose up -d dgraph dgraph-client

      set +e
      ./scripts/test.sh > "output_${CI_PROJECT_NAME}.txt"
      test_status=$?
      set -e

      cp "output_${CI_PROJECT_NAME}.txt" ..
      exit "$test_status"
      RUN_TEST
    - bash run-tests.sh
  artifacts:
    paths:
      - output_${CI_PROJECT_NAME}.txt
  rules:
    - if: $CI_COMMIT_TAG =~ /^test.*/
